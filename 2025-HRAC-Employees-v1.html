<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>U.S. Employees Enrolled in Health Coverage via ICHRA/QSEHRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; inset:0; }

    :root{
      --panel-bg:#ffffff; --panel-fg:#000000; --muted:#555; --shadow:0 1px 3px rgba(0,0,0,.2);
    }

    .panel{ background:var(--panel-bg); color:var(--panel-fg); padding:10px; border-radius:8px; box-shadow:var(--shadow); font-family:sans-serif; }
    .title{ position:absolute; top:10px; left:10px; z-index:2; max-width:360px; }
    .title h1{ font-size:16px; margin:0 0 6px 0; }
    .title p{ margin:0; font-size:14px; line-height:1.4; color:var(--muted); }

    .controls{ position:absolute; top:10px; right:10px; z-index:2; font-size:13px; line-height:1.3; width:300px; max-height:60vh; overflow:auto; padding-bottom:4px; }

    /* Accordion */
    .section{ border:1px solid rgba(0,0,0,.08); border-radius:6px; margin-bottom:8px; overflow:hidden; }
    .section .header{ display:flex; justify-content:space-between; align-items:center; padding:10px; cursor:pointer; user-select:none; background:rgba(0,0,0,.04); }
    .section .header h2{ font-size:12px; text-transform:uppercase; letter-spacing:.04em; margin:0; opacity:.9; }
    .chev{ transition:transform .15s ease; }
    .section.collapsed .chev{ transform:rotate(-90deg); }
    .section .content{ padding:10px; display:block; }
    .section.collapsed .content{ display:none; }

    /* Compact checkbox grid */
    .grid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:6px 10px; }
    .chip{ display:flex; align-items:center; gap:6px; }
    .chip input[type="checkbox"]{ width:14px; height:14px; accent-color:#333; cursor:pointer; }

    .legend{ position:absolute; left:10px; bottom:30px; z-index:1; font-size:12px; }
    .legend .color-row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
    .swatch{ width:14px; height:14px; border-radius:3px; display:inline-block; }
    .circle-swatch{ display:inline-block; border-radius:50%; background:#4FB848; vertical-align:middle; margin-right:6px; }
    .note{ color:var(--muted); margin-top:6px; font-size:12px; }
    .mapboxgl-ctrl-group{ box-shadow:var(--shadow); }
  </style>
</head>
<body>
<div id="map"></div>

<div class="panel title">
  <h1>U.S. Employees Enrolled in Health Coverage via ICHRA/QSEHRA</h1>
  <p>Employee-level point locations derived from data shared by participating HRA Council Members. Use the Plan Type filter to highlight metal tiers. Click any point for age, dependents, and plan detail.</p>
</div>

<div class="panel controls" id="controls">
  <!-- Plan ONLY -->
  <div class="section" id="sec-plan">
    <div class="header"><h2>Plan Type</h2><span class="chev">â–¾</span></div>
    <div class="content"><div class="grid" id="plan-group"></div></div>
  </div>
</div>

<div class="panel legend">
  <strong>Plan Colors</strong>
  <div class="color-row"><span class="swatch" style="background:#cd7f32"></span> Expanded Bronze, Bronze</div>
  <div class="color-row"><span class="swatch" style="background:#c0c0c0"></span> Silver</div>
  <div class="color-row"><span class="swatch" style="background:#ffd602"></span> Gold</div>
  <div class="color-row"><span class="swatch" style="background:#e5e4e2"></span> Platinum</div>
  <div class="color-row"><span class="swatch" style="background:#d9534f"></span> Catastrophic</div>
  <div class="color-row"><span class="swatch" style="background:#4e81bd"></span> Medicare Advantage</div>
  <hr style="border:none;border-top:1px solid rgba(0,0,0,.12);margin:8px 0" />
  <strong>Circle Size = Dependents</strong><br>
  <div><span class="circle-swatch" style="width:4px;height:4px;"></span> 1</div>
  <div><span class="circle-swatch" style="width:6px;height:6px;"></span> 2</div>
  <div><span class="circle-swatch" style="width:8px;height:8px;"></span> 3</div>
  <div><span class="circle-swatch" style="width:10px;height:10px;"></span> 4</div>
  <div><span class="circle-swatch" style="width:12px;height:12px;"></span> 5</div>
  <div><span class="circle-swatch" style="width:14px;height:14px;"></span> 6</div>
  <div><span class="circle-swatch" style="width:16px;height:16px;"></span> 7</div>
  <div><span class="circle-swatch" style="width:18px;height:18px;"></span> 8+</div>
  <div class="note">Legend is scaled to the default desktop zoom.</div>
</div>

<script>
  // === CONFIG ===
  mapboxgl.accessToken = 'pk.eyJ1IjoiaHJhY291bmNpbCIsImEiOiJjbWQ2OTVscWkwNzg0Mm1wczN1a2dybmd1In0.omasVaTqz8i1i-aKPYAmog';
  const STYLE_URL = 'mapbox://styles/hracouncil/cmdsy6waj00p101qp8segfi94?v=2025-08-12';
  const LAYER_DOTS = 'Employee Dots';

  // Field keys (dot layer only)
  const FIELDS = { age: 'Employee_Age', deps: 'Dependents', plan: 'Gold' };

  const PLAN_OPTIONS = ['Bronze','Expanded Bronze','Silver','Gold','Platinum','Catastrophic','Medicare Advantage'];

  // Build checkbox group for Plan
  function addChecks(containerId, items, idPrefix){
    const el = document.getElementById(containerId); el.innerHTML='';
    items.forEach((label,i)=>{
      const id = idPrefix+"-"+i;
      const wrap = document.createElement('label'); wrap.className='chip';
      wrap.innerHTML = `<input type="checkbox" id="${id}" checked> <span>${label}</span>`;
      el.appendChild(wrap);
    });
  }
  addChecks('plan-group', PLAN_OPTIONS, 'plan');

  // Accordion wiring
  document.querySelectorAll('.section .header').forEach(h=>{
    h.addEventListener('click', ()=> h.parentElement.classList.toggle('collapsed'));
  });

  // Map init
  const map = new mapboxgl.Map({
    container:'map',
    style: STYLE_URL,
    center: [-98.5795, 39.8283],
    zoom: 3.2
  });
  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

  // Resolve sub-layers in case Studio renamed
  function resolveLayerIds(label){
    const norm = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const want = norm(label); const ids=[];
    (map.getStyle().layers||[]).forEach(l=>{
      const idMatch=norm(l.id).includes(want);
      const srcMatch=norm(l['source-layer']||'').includes(want);
      if(idMatch||srcMatch) ids.push(l.id);
    });
    return ids.length? ids : [label];
  }

  map.on('load', () => {
    map.fitBounds([[-125,24],[-66.5,49]], { padding:20 });

    const DOT_LAYER_IDS = resolveLayerIds(LAYER_DOTS);

    // helpers
    function getSelected(prefix, labels){
      const out=[]; labels.forEach((lbl,i)=>{ const el=document.getElementById(`${prefix}-${i}`); if(el&&el.checked) out.push(lbl); }); return out;
    }

    function buildPlanFilter(){
      const sel = getSelected('plan', PLAN_OPTIONS);
      if(sel.length === PLAN_OPTIONS.length) return null; if(sel.length===0) return ['literal', false];
      const upper = sel.map(s=>s.toUpperCase());
      const any=['any'];
      const candidates=[ ['upcase',['get',FIELDS.plan]], ['upcase',['get','Plan']], ['upcase',['get','Metal']], ['upcase',['get','top_metal']] ];
      candidates.forEach(expr=> any.push(['in',expr,['literal',upper]]));
      // Also accept boolean/1/yes flags if present (e.g., "gold"=1)
      upper.forEach(p=>{
        const k=p.toLowerCase();
        any.push(['any',
          ['==',['downcase',['get',k]],'yes'],
          ['==',['to-number',['get',k]],1],
          ['==',['get',k],true]
        ]);
      });
      return any;
    }

    function applyFilters(){
      const fDots = buildPlanFilter();
      DOT_LAYER_IDS.forEach(id=> map.setFilter(id, fDots));
    }

    // Wire listeners
    for(let i=0;i<PLAN_OPTIONS.length;i++){
      const el=document.getElementById(`plan-${i}`);
      if(el) el.addEventListener('change', applyFilters);
    }

    applyFilters();

    // Popups for dots only
    DOT_LAYER_IDS.forEach(id=>{
      map.on('click', id, e=>{
        const p=e.features[0].properties;
        new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(`
          <strong>Age:</strong> ${p[FIELDS.age] ?? 'N/A'}<br>
          <strong>Dependents:</strong> ${p[FIELDS.deps] ?? 'N/A'}<br>
          <strong>Plan:</strong> ${p[FIELDS.plan] ?? 'N/A'}
        `).addTo(map);
      });
      map.on('mouseenter', id, ()=> map.getCanvas().style.cursor='pointer');
      map.on('mouseleave', id, ()=> map.getCanvas().style.cursor='');
    });
  });
</script>
</body>
</html>
